<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠŸå¤«èŒ¶åº«å­˜è¡¨ - è¶…ç°¡æ˜“ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        /* ä¸‹æ‹‰èœå•æ ·å¼ */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dropdown-toggle::after {
            content: 'â–¼';
            font-size: 0.7em;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            min-width: 180px;
            margin-top: 5px;
            overflow: hidden;
        }

        .dropdown.active .dropdown-menu {
            display: block;
            animation: fadeIn 0.2s;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: white;
            color: #333;
            width: 100%;
            text-align: left;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dropdown-item:hover {
            background: #f0f0f0;
        }

        .dropdown-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 5px 0;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #38ef7d;
            color: white;
        }

        .btn-warning {
            background: #ffa500;
            color: white;
        }

        .btn-save {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            color: white;
            border: 2px solid #fff;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            position: relative;
            overflow: hidden;
            animation: pulse 2s infinite;
        }

        .btn-save::before {
            content: 'â­';
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            animation: sparkle 3s infinite;
            font-size: 1.2em;
        }

        .btn-save::after {
            content: 'â­';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            animation: sparkle 3s infinite 1.5s;
            font-size: 1.2em;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            }
            50% {
                box-shadow: 0 4px 25px rgba(255, 107, 107, 0.8);
            }
        }

        @keyframes sparkle {
            0%, 100% {
                opacity: 0;
                transform: translateY(-50%) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translateY(-50%) scale(1.2);
            }
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-save:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        thead {
            background: #667eea;
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .stock-input {
            width: 80px;
            padding: 5px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
        }

        .stock-low {
            color: #ff6b6b;
            background: #fff5f5;
        }

        .qty-btn {
            padding: 5px 12px;
            margin: 0 3px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.2s;
        }

        .qty-btn:hover {
            transform: scale(1.1);
        }

        .btn-minus {
            background: #ff6b6b;
            color: white;
        }

        .btn-plus {
            background: #38ef7d;
            color: white;
        }

        .btn-restock {
            background: #38ef7d;
            color: white;
            padding: 6px 12px;
            margin-left: 5px;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            text-align: center;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            display: block;
        }

        .info-box {
            background: linear-gradient(135deg, #fff9e6 0%, #fff3d6 100%);
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #ff9800;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
        }

        .info-box-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background 0.3s;
            background: linear-gradient(135deg, #ffe0b2 0%, #ffcc80 100%);
        }

        .info-box-header:hover {
            background: linear-gradient(135deg, #ffd699 0%, #ffb84d 100%);
        }

        .info-box h3 {
            color: #e65100;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s;
        }

        .info-box.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .info-box-content {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }

        .info-box:not(.collapsed) .info-box-content {
            max-height: 500px;
            padding: 0 20px 20px 20px;
            opacity: 1;
            visibility: visible;
        }

        .info-box p {
            color: #333;
            line-height: 1.8;
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        
        .info-box p strong {
            color: #d84315;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .stat-card {
            padding: 10px 12px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-card:nth-child(1) {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #fa709a, #fee140);
            color: white;
        }

        .stat-card:nth-child(4) {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
        }

        .stat-label {
            font-size: 0.75em;
            opacity: 0.95;
            margin-bottom: 3px;
            white-space: nowrap;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            line-height: 1;
        }

        /* å¤šæ¬„å¡ç‰‡å¸ƒå±€ */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .view-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
        }

        .category-section {
            margin-bottom: 20px;
        }

        .category-title {
            font-size: clamp(1.1em, 2.5vw, 1.4em);
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
        }

        .category-count {
            font-size: clamp(0.65em, 1.5vw, 0.75em);
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 20px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .item-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 8px;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            min-width: 0;
            overflow: hidden;
        }

        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .item-card.low-stock {
            border-color: #ff6b6b;
            background: #fff5f5;
        }

        .item-card.out-of-stock {
            border-color: #dc3545;
            background: #ffe5e5;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
            gap: 3px;
        }

        .item-name {
            font-size: clamp(0.75em, 1.8vw, 0.95em);
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
            line-height: 1.1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .item-unit {
            font-size: clamp(0.6em, 1.2vw, 0.7em);
            color: #666;
            background: #f0f0f0;
            padding: 1px 4px;
            border-radius: 3px;
            display: inline-block;
            white-space: nowrap;
        }

        .status-badge {
            font-size: clamp(0.9em, 2vw, 1.1em);
            margin-left: 3px;
            flex-shrink: 0;
        }

        .card-body {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stock-row, .shortage-row {
            display: flex;
            align-items: center;
            gap: 4px;
            justify-content: space-between;
        }

        .stock-label {
            font-size: clamp(0.65em, 1.4vw, 0.75em);
            color: #666;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .stock-input-card {
            width: clamp(45px, 8vw, 65px);
            padding: 3px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: clamp(0.8em, 1.6vw, 0.9em);
            font-weight: bold;
            flex-shrink: 0;
        }

        .card-actions {
            display: flex;
            gap: 3px;
            margin-top: 4px;
        }

        .card-actions .qty-btn {
            flex: 1;
            padding: 4px 2px;
            font-size: clamp(0.7em, 1.4vw, 0.8em);
            white-space: nowrap;
            min-width: 0;
        }

        .table-view {
            display: block;
        }

        .card-view, .order-view, .quick-view {
            display: none;
        }

        .view-card .table-view {
            display: none;
        }

        .view-card .card-view {
            display: block;
        }

        .view-quick .table-view,
        .view-quick .card-view {
            display: none;
        }

        .view-quick .quick-view {
            display: block;
        }

        .view-order .table-view,
        .view-order .card-view {
            display: none;
        }

        .view-order .order-view {
            display: block;
        }

        .order-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .order-table th {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            text-align: left;
        }

        .order-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .order-table tr:hover {
            background: #fff5f5;
        }

        .order-summary {
            background: #fff5f5;
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .order-summary h3 {
            color: #ff6b6b;
            margin-bottom: 15px;
        }

        .order-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .order-stat-item {
            flex: 1;
            min-width: 150px;
            text-align: center;
        }

        .order-stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .order-stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #ff6b6b;
        }

        .need-order-badge {
            background: #ff6b6b;
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: bold;
        }

        /* å¿«é€Ÿä½¿ç”¨è¦–åœ– */
        .quick-search {
            margin-bottom: 15px;
        }

        .quick-search input {
            width: 100%;
            padding: clamp(10px, 2vw, 15px);
            font-size: clamp(1em, 2vw, 1.2em);
            border: 3px solid #667eea;
            border-radius: 10px;
            text-align: center;
        }

        .quick-search input:focus {
            outline: none;
            border-color: #38ef7d;
            box-shadow: 0 0 10px rgba(56, 239, 125, 0.3);
        }

        .usage-log {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .usage-log h4 {
            margin: 0 0 10px 0;
            color: #667eea;
        }

        .usage-item {
            padding: 8px 12px;
            background: white;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #667eea;
            position: relative;
        }

        .usage-item.recent {
            animation: fadeIn 0.5s;
            background: #e7f3ff;
        }

        .usage-delete-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 4px 10px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .usage-delete-btn:hover {
            background: #dc3545;
            transform: scale(1.05);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .usage-time {
            font-size: 0.85em;
            color: #999;
        }

        .quick-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            min-width: 0;
            overflow: hidden;
        }

        .quick-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border-color: #667eea;
        }

        .quick-item:active {
            transform: scale(0.95);
        }

        .quick-item.low-stock {
            border-color: #ff6b6b;
            background: #fff5f5;
        }

        .quick-item.out-of-stock {
            border-color: #dc3545;
            background: #ffe5e5;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .quick-item-name {
            font-size: clamp(0.7em, 1.6vw, 0.85em);
            font-weight: bold;
            margin-bottom: 4px;
            color: #333;
            line-height: 1.1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .quick-item-stock {
            font-size: clamp(1.2em, 2.5vw, 1.5em);
            font-weight: bold;
            margin: 4px 0;
        }

        .quick-item-stock.low {
            color: #ff6b6b;
        }

        .quick-item-stock.out {
            color: #dc3545;
        }

        .quick-item-stock.ok {
            color: #38ef7d;
        }

        .quick-item-unit {
            font-size: clamp(0.6em, 1.2vw, 0.7em);
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .quick-item-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            font-size: clamp(0.9em, 2vw, 1.1em);
        }

        .quick-category-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background: #667eea;
            color: white;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        /* è¶…å¤§å±å¹• - 5æ æˆ–æ›´å¤š */
        @media (min-width: 1400px) {
            .cards-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 12px;
            }
            
            .item-card {
                padding: 10px;
            }
        }

        /* å¤§å±å¹• - 4æ  */
        @media (max-width: 1399px) and (min-width: 1024px) {
            .cards-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 10px;
            }
        }

        /* ä¸­å±å¹• - 3æ  */
        @media (max-width: 1023px) and (min-width: 768px) {
            .cards-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
            
            .item-card {
                padding: 8px;
            }
        }

        /* å°å±å¹• - 2æ  */
        @media (max-width: 767px) and (min-width: 481px) {
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .item-card {
                padding: 8px;
            }
        }

        /* è¶…å°å±å¹• - 1æ  */
        @media (max-width: 480px) and (min-width: 1px) {
            .cards-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .item-card {
                padding: 10px;
            }
            
            .item-name {
                font-size: 1em;
                white-space: normal;
            }
            
            .stock-label {
                font-size: 0.85em;
            }
            
            .stock-input-card {
                width: 70px;
                font-size: 1em;
            }
            
            .card-actions .qty-btn {
                font-size: 0.9em;
                padding: 6px 8px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                border-radius: 10px;
            }

            h1 {
                font-size: 1.5em;
                margin-bottom: 5px;
            }

            .subtitle {
                font-size: 0.9em;
                margin-bottom: 15px;
            }

            .controls {
                gap: 8px;
            }

            .btn, .dropdown-toggle {
                padding: 8px 12px;
                font-size: 0.85em;
            }

            .btn-save {
                font-size: 0.9em;
                padding: 10px 15px;
            }

            .view-toggle {
                gap: 6px;
                margin-bottom: 15px;
            }

            .view-btn {
                padding: 8px 12px;
                font-size: 0.8em;
            }

            .stats {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }

            .stat-card {
                padding: 8px 6px;
            }

            .stat-label {
                font-size: 0.65em;
            }

            .stat-value {
                font-size: 1.5em;
            }

            .dropdown-menu {
                min-width: 160px;
            }

            .dropdown-item {
                padding: 10px 12px;
                font-size: 0.85em;
            }

            table {
                font-size: 0.8em;
            }

            th, td {
                padding: 8px 6px;
            }

            .modal-dialog {
                padding: 20px 15px;
                width: 95%;
            }

            .modal-title {
                font-size: 1.3em;
            }

            .info-box {
                margin-bottom: 15px;
            }

            .info-box-header {
                padding: 12px 15px;
            }

            .info-box h3 {
                font-size: 1em;
            }
        }

        /* æ¨¡æ…‹å½ˆçª—æ¨£å¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-dialog {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.7);
            opacity: 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .modal-overlay.active .modal-dialog {
            transform: scale(1);
            opacity: 1;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .modal-icon {
            font-size: 4em;
            margin-bottom: 15px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }

        .modal-input.error {
            border-color: #ff6b6b;
            animation: shake 0.5s;
        }

        .modal-input.success {
            border-color: #38ef7d;
            background: #f0fff4;
        }

        @keyframes successPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .modal-dialog.success {
            animation: successPulse 0.3s ease;
        }

        .modal-title {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .modal-subtitle {
            color: #666;
            font-size: 1em;
            line-height: 1.6;
        }

        .modal-body {
            margin: 30px 0;
        }

        .modal-input-group {
            margin-bottom: 20px;
        }

        .modal-label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .modal-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 1.1em;
            transition: all 0.3s;
            text-align: center;
            letter-spacing: 5px;
            font-weight: bold;
        }

        .modal-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
            transform: scale(1.02);
        }

        .modal-footer {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .modal-btn {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.5);
        }

        .modal-btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .modal-btn-secondary:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f0f0f0;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: #ff6b6b;
            color: white;
            transform: rotate(90deg);
        }

        .password-hint {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }

        .password-hint p {
            margin: 5px 0;
            color: #555;
            font-size: 0.95em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ åŠŸå¤«èŒ¶åº«å­˜è¡¨</h1>
        <p class="subtitle">æ¥Šæ¢…å››ç¶­åº— - è¶…ç°¡æ˜“ç‰ˆï¼ˆè³‡æ–™è‡ªå‹•å„²å­˜ï¼‰</p>

        <div class="info-box collapsed" id="infoBox">
            <div class="info-box-header" onclick="toggleInfoBox()">
                <h3>ğŸ’¡ å¿«é€Ÿä¸Šæ‰‹æŒ‡å—</h3>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="info-box-content" style="max-height: 0; padding: 0 20px; opacity: 0; visibility: hidden;">
                <p><strong style="color: #e65100; font-size: 1.1em;">ğŸ“Š å››ç¨®è¦–åœ–æ¨¡å¼ï¼š</strong></p>
                <p>â€¢ <strong>è¡¨æ ¼è¦–åœ–</strong>ï¼šå®Œæ•´è³‡æ–™ç®¡ç†ï¼Œå¯ç›´æ¥ä¿®æ”¹åº«å­˜ã€è£œè²¨é‡ï¼Œé©åˆç›¤é»</p>
                <p>â€¢ <strong>å¡ç‰‡è¦–åœ–</strong>ï¼šæŒ‰é¡åˆ¥åˆ†çµ„é¡¯ç¤ºï¼Œå¤§å¡ç‰‡æ˜“æ“ä½œï¼Œé©åˆå¿«é€Ÿç€è¦½</p>
                <p>â€¢ <strong>âš¡ å¿«é€Ÿä½¿ç”¨</strong>ï¼šé»æ“Šå•†å“ç›´æ¥æ‰£åº«å­˜ï¼ˆ-1ï¼‰ï¼Œèª¤é»å¯åˆªé™¤è¨˜éŒ„å›è£œï¼Œæœ€å¸¸ç”¨ï¼</p>
                <p>â€¢ <strong>å«è²¨æ¸…å–®</strong>ï¼šè‡ªå‹•é¡¯ç¤ºéœ€è£œè²¨å•†å“ï¼Œå¯åŒ¯å‡ºè¨‚è³¼å–®</p>
                
                <p style="margin-top: 15px;"><strong style="color: #e65100; font-size: 1.1em;">â˜ï¸ é›²ç«¯åŒæ­¥ï¼š</strong></p>
                <p>â€¢ <strong style="color: #ff6b6b;">ç´…è‰²é–ƒçˆæŒ‰éˆ•ã€Œå„²å­˜åˆ°é›²ç«¯Excelã€</strong> - æ‰€æœ‰äººéƒ½å¯ä»¥å„²å­˜ï¼ˆç„¡éœ€å¯†ç¢¼ï¼‰</p>
                <p>â€¢ <strong>å¾é›²ç«¯Excelè®€å–</strong> - éœ€è¦å¯†ç¢¼ <span style="background: #fff; padding: 2px 8px; border-radius: 4px; font-family: monospace;">0825</span>ï¼ˆåƒ…åº—é•·/å‰¯åº—é•·ï¼‰</p>
                <p>â€¢ ğŸ’¾ <strong>æœ¬åœ°è‡ªå‹•å„²å­˜</strong>ï¼šæ¯æ¬¡æ“ä½œéƒ½æœƒè‡ªå‹•å­˜åœ¨ç€è¦½å™¨ä¸­</p>
                
                <p style="margin-top: 15px;"><strong style="color: #e65100; font-size: 1.1em;">ğŸ¯ é‡é»åŠŸèƒ½ï¼š</strong></p>
                <p>â€¢ ğŸ“¦ <strong>è£œè²¨æŒ‰éˆ•</strong>ï¼šæ”¶åˆ°è²¨é»æ“Šã€Œè£œè²¨åˆ°è²¨ã€ï¼Œè‡ªå‹•å¢åŠ åº«å­˜</p>
                <p>â€¢ ğŸ” <strong>æœå°‹éæ¿¾</strong>ï¼šå¿«é€Ÿæ‰¾åˆ°æƒ³è¦çš„å•†å“ï¼Œæ”¯æ´åç¨±å’Œé¡åˆ¥æœå°‹</p>
                <p>â€¢ ğŸ¨ <strong>é¡è‰²è­¦ç¤º</strong>ï¼šç´…è‰²=ç¼ºè²¨/ä½åº«å­˜ï¼Œé»ƒè‰²=éœ€æ³¨æ„ï¼Œç¶ è‰²=å……è¶³</p>
                <p>â€¢ ğŸ“¥ <strong>åŒ¯å‡ºCSV</strong>ï¼šå¯åœ¨ Excel æˆ– Google Sheets ä¸­é–‹å•Ÿç·¨è¼¯</p>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">ç¸½å•†å“æ•¸</div>
                <div class="stat-value" id="totalItems">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ä½åº«å­˜è­¦ç¤º</div>
                <div class="stat-value" id="lowStock">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">éœ€è¦è£œè²¨</div>
                <div class="stat-value" id="needRestock">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ç¼ºè²¨é …ç›®</div>
                <div class="stat-value" id="outOfStock">0</div>
            </div>
        </div>

        <div class="view-toggle">
            <button class="view-btn" onclick="switchView('table')">ğŸ“‹ è¡¨æ ¼è¦–åœ–</button>
            <button class="view-btn" onclick="switchView('card')">ğŸ´ å¡ç‰‡è¦–åœ–</button>
            <button class="view-btn active" onclick="switchView('quick')">âš¡ å¿«é€Ÿä½¿ç”¨</button>
            <button class="view-btn" onclick="switchView('order')">ğŸ“ å«è²¨æ¸…å–®</button>
        </div>

        <div class="controls">
            <button class="btn btn-save" onclick="syncToSheets()" id="syncBtn">â­ ğŸ’¾ å„²å­˜åˆ°é›²ç«¯Excel â­</button>
            
            <div class="dropdown" id="dataDropdown">
                <button class="dropdown-toggle" onclick="toggleDropdown('dataDropdown')">
                    ğŸ“‚ è³‡æ–™ç®¡ç†
                </button>
                <div class="dropdown-menu">
                    <button class="dropdown-item" onclick="window.open('https://docs.google.com/spreadsheets/d/15u3_XJCf7sqhCVKb0WKQU89S_7_s_Oy0Hu9nN53aubo/edit?gid=165804177#gid=165804177', '_blank'); closeDropdown('dataDropdown')">
                        ğŸ“Š å¾Œå°åº«å­˜è¡¨
                    </button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" onclick="loadFromSheets(); closeDropdown('dataDropdown')">
                        â˜ï¸ å¾é›²ç«¯EXCELè®€å–
                    </button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" onclick="exportToCSV(); closeDropdown('dataDropdown')">
                        ğŸ“¥ åŒ¯å‡ºCSV
                    </button>
                    <button class="dropdown-item" onclick="exportOrderList(); closeDropdown('dataDropdown')">
                        ğŸ“‹ åŒ¯å‡ºå«è²¨å–®
                    </button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" onclick="if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) clearAllData(); closeDropdown('dataDropdown')">
                        ğŸ—‘ï¸ æ¸…ç©ºè³‡æ–™
                    </button>
                </div>
            </div>

            <button class="btn btn-warning" onclick="showSheetsConfig()" style="display: none;" id="configBtn">âš™ï¸ è¨­å®š</button>
        </div>

        <div id="status" class="status"></div>

        <!-- è¡¨æ ¼è¦–åœ– -->
        <div class="table-view">
            <table id="inventoryTable">
                <thead>
                    <tr>
                        <th>é¡åˆ¥</th>
                        <th>å•†å“åç¨±</th>
                        <th>å–®ä½</th>
                        <th>å¸¸æ…‹åº«å­˜</th>
                        <th>ç¾æœ‰åº«å­˜</th>
                        <th>çŸ­ç¼ºæ•¸é‡</th>
                        <th>å¿«é€Ÿæ“ä½œ</th>
                        <th>ç‹€æ…‹</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- è³‡æ–™æœƒå‹•æ…‹è¼‰å…¥ -->
                </tbody>
            </table>
        </div>

        <!-- å¡ç‰‡è¦–åœ– -->
        <div class="card-view" id="cardView">
            <!-- å¡ç‰‡æœƒå‹•æ…‹è¼‰å…¥ -->
        </div>

        <!-- å¿«é€Ÿä½¿ç”¨è¦–åœ– -->
        <div class="quick-view" id="quickView">
            <!-- å¿«é€Ÿä½¿ç”¨æœƒå‹•æ…‹è¼‰å…¥ -->
        </div>

        <!-- å«è²¨æ¸…å–®è¦–åœ– -->
        <div class="order-view" id="orderView">
            <!-- å«è²¨æ¸…å–®æœƒå‹•æ…‹è¼‰å…¥ -->
        </div>
    </div>

    <!-- æ¨¡æ…‹å½ˆçª— - å¯†ç¢¼è¼¸å…¥ -->
    <div class="modal-overlay" id="passwordModal" onclick="handleModalOverlayClick(event)">
        <div class="modal-dialog" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closePasswordModal()">Ã—</button>
            <div class="modal-header">
                <div class="modal-icon">ğŸ”</div>
                <h2 class="modal-title">æ¬Šé™é©—è­‰</h2>
                <p class="modal-subtitle">å¾é›²ç«¯Excelè®€å–è³‡æ–™éœ€è¦é©—è­‰èº«ä»½</p>
            </div>
            <div class="modal-body">
                <div class="modal-input-group">
                    <label class="modal-label">è«‹è¼¸å…¥å¯†ç¢¼ï¼ˆåº—é•·/å‰¯åº—é•·ï¼‰</label>
                    <input type="password" 
                           id="passwordInput" 
                           class="modal-input" 
                           placeholder="â€¢â€¢â€¢â€¢"
                           maxlength="4"
                           onkeypress="handlePasswordKeypress(event)">
                </div>
                <div class="password-hint">
                    <p>ğŸ’¡ <strong>æç¤ºï¼š</strong></p>
                    <p>â€¢ è«‹è¼¸å…¥4ä½æ•¸å¯†ç¢¼</p>
                    <p>â€¢ åªæœ‰åº—é•·å’Œå‰¯åº—é•·æœ‰æ¬Šè®€å–é›²ç«¯è³‡æ–™</p>
                    <p>â€¢ å¯†ç¢¼éŒ¯èª¤å°‡ç„¡æ³•è¼‰å…¥è³‡æ–™</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closePasswordModal()">
                    å–æ¶ˆ
                </button>
                <button class="modal-btn modal-btn-primary" onclick="verifyPassword()">
                    âœ“ ç¢ºèªè®€å–
                </button>
            </div>
        </div>
    </div>

    <script>
        // é è¨­è³‡æ–™ï¼ˆä¾†è‡ª Google Sheetsï¼‰
        const defaultData = [
            // æœéœ²é¡
            { category: 'æœéœ²é¡', name: 'é»ƒé‡‘èŠ’æœè†', unit: '1ç®±6å…¥', stock: 1, shortage: 2, normalStock: 5 },
            { category: 'æœéœ²é¡', name: 'å¤æ—©å‘³ç¿ æ¢…æ±', unit: '1ç®±6å…¥', stock: 6, shortage: 0, normalStock: 8 },
            { category: 'æœéœ²é¡', name: 'é ‚ç´šç™¾é¦™æœé†¬', unit: '1ç®±4å…¥', stock: 4, shortage: 0, normalStock: 6 },
            { category: 'æœéœ²é¡', name: 'å†¬ç“œéœ²', unit: '1ç®±10å…¥', stock: 9, shortage: 1, normalStock: 12 },
            { category: 'æœéœ²é¡', name: 'æ²–ç¹©é»‘ç³–è–‘èŒ¶', unit: 'å–®ç½è³¼', stock: 1, shortage: 0, normalStock: 3 },
            { category: 'æœéœ²é¡', name: 'é ‚ç´šç´…æŸšæ±', unit: '1ç®±4å…¥', stock: 0, shortage: 3, normalStock: 4 },
            { category: 'æœéœ²é¡', name: 'ç«ç‘°èŠ±é‡€', unit: 'å–®ç½è³¼', stock: 1, shortage: 1, normalStock: 3 },
            { category: 'æœéœ²é¡', name: 'æ¡‚åœ“ç´…æ£—é†¬', unit: 'å–®ç½è³¼', stock: 1, shortage: 0, normalStock: 2 },
            { category: 'æœéœ²é¡', name: 'æ¥Šæ¡ƒèœœ', unit: 'ä¸€ç®±/6åŒ…', stock: 3, shortage: 0, normalStock: 5, note: 'â€»åº«å­˜å–®ä½ï¼šç®±' },
            
            // ç²‰é¡
            { category: 'ç²‰é¡', name: 'å¥¶ç²¾ç²‰', unit: '1ç®±20åŒ…', stock: 20, shortage: 3, normalStock: 25 },
            { category: 'ç²‰é¡', name: 'ç²‰ç²¿ç²‰', unit: '1è¢‹5åŒ…', stock: 6, shortage: 1, normalStock: 10 },
            
            // ç³–é¡
            { category: 'ç³–é¡', name: 'åŠŸå¤«èŒ¶èœ‚èœœ', unit: '1ç®±5å…¥', stock: 10, shortage: 2, normalStock: 15 },
            { category: 'ç³–é¡', name: 'ç±³ä½¶ç”˜è”—ç³–', unit: 'å–®æ¡¶è³¼', stock: 1, shortage: 1, normalStock: 3, allowDecimal: true },
            { category: 'ç³–é¡', name: 'å°ç£é»‘ç³–ç²‰', unit: 'å–®åŒ…è³¼', stock: 1, shortage: 1, normalStock: 3, allowDecimal: true },
            
            // èŒ¶è‘‰é¡
            { category: 'èŒ¶è‘‰é¡', name: 'å››å­£æ˜¥èŒ¶', unit: '1ç®±5åŒ…', stock: 3, shortage: 2, normalStock: 8 },
            { category: 'èŒ¶è‘‰é¡', name: 'ç´…çƒé¾', unit: '1ç®±5åŒ…', stock: 2, shortage: 0, normalStock: 5 },
            { category: 'èŒ¶è‘‰é¡', name: 'æ±æ–¹ç¾äººèŒ¶', unit: '1ç®±5åŒ…', stock: 0, shortage: 0, normalStock: 3 },
            { category: 'èŒ¶è‘‰é¡', name: 'ç‚­ç„™çƒé¾èŒ¶', unit: '1ç®±5åŒ…', stock: 5, shortage: 0, normalStock: 8 },
            { category: 'èŒ¶è‘‰é¡', name: 'é«˜å±±èŒ¶', unit: '1ç®±5åŒ…', stock: 3, shortage: 1, normalStock: 6 },
            { category: 'èŒ¶è‘‰é¡', name: 'å°è‘‰ç´…èŒ¶', unit: '1ç®±5åŒ…', stock: 10, shortage: 1, normalStock: 12 },
            { category: 'èŒ¶è‘‰é¡', name: 'é‡‘è±èŒ¶', unit: '1ç®±5åŒ…', stock: 2, shortage: 1, normalStock: 5 },
            { category: 'èŒ¶è‘‰é¡', name: 'æ¸…é¦™çƒé¾', unit: '1ç®±5åŒ…', stock: 4, shortage: 0, normalStock: 6 },
            { category: 'èŒ¶è‘‰é¡', name: 'éµè§€éŸ³', unit: '1ç®±5åŒ…', stock: 1, shortage: 0, normalStock: 4 },
            { category: 'èŒ¶è‘‰é¡', name: 'èœœé¦™ç´…èŒ¶', unit: '1ç®±5åŒ…', stock: 2, shortage: 0, normalStock: 5 },
            { category: 'èŒ¶è‘‰é¡', name: 'èŒ‰è‰ç¶ èŒ¶', unit: '1ç®±5åŒ…', stock: 6, shortage: 1, normalStock: 8 },
            { category: 'èŒ¶è‘‰é¡', name: 'åŒ…ç¨®èŒ¶', unit: '1ç®±5åŒ…', stock: 3, shortage: 0, normalStock: 5 },
            
            // å°æ–™é¡
            { category: 'å°æ–™é¡', name: 'çç ', unit: '1ç®±12åŒ…', stock: 5, shortage: 3, normalStock: 10 },
            { category: 'å°æ–™é¡', name: 'æ¤°æœ', unit: '1ç®±6ç“¶', stock: 2, shortage: 1, normalStock: 5 },
            { category: 'å°æ–™é¡', name: 'ç²‰ç²¿', unit: '1ç®±20åŒ…', stock: 10, shortage: 0, normalStock: 15 },
            { category: 'å°æ–™é¡', name: 'ä»™è‰å‡', unit: '1ç®±20åŒ…', stock: 8, shortage: 1, normalStock: 12 },
            { category: 'å°æ–™é¡', name: 'å¸ƒä¸', unit: '1ç®±10åŒ…', stock: 4, shortage: 0, normalStock: 8 },
            { category: 'å°æ–™é¡', name: 'è˜†è–ˆ', unit: '1ç®±6ç“¶', stock: 3, shortage: 0, normalStock: 5 },
            { category: 'å°æ–™é¡', name: 'ç´…è±†', unit: '1ç®±12åŒ…', stock: 6, shortage: 1, normalStock: 10 },
            { category: 'å°æ–™é¡', name: 'ç¶ è±†', unit: '1ç®±12åŒ…', stock: 2, shortage: 0, normalStock: 6 },
            { category: 'å°æ–™é¡', name: 'è–ä»', unit: '1ç®±12åŒ…', stock: 1, shortage: 0, normalStock: 4 },
            { category: 'å°æ–™é¡', name: 'QQ', unit: '1ç®±12åŒ…', stock: 5, shortage: 0, normalStock: 8 },
            { category: 'å°æ–™é¡', name: 'èŠ‹åœ“', unit: '1ç®±10åŒ…', stock: 3, shortage: 1, normalStock: 6 },
            { category: 'å°æ–™é¡', name: 'åœ°ç“œåœ“', unit: '1ç®±10åŒ…', stock: 2, shortage: 0, normalStock: 5 },
            { category: 'å°æ–™é¡', name: 'æ°´æ™¶ç²‰åœ“', unit: '1ç®±12åŒ…', stock: 0, shortage: 2, normalStock: 6 },
            
            // åŒ…æé¡
            { category: 'åŒ…æé¡', name: '500mlæ¯å­', unit: '1ç®±1000å€‹', stock: 3, shortage: 1, normalStock: 5 },
            { category: 'åŒ…æé¡', name: '700mlæ¯å­', unit: '1ç®±1000å€‹', stock: 2, shortage: 0, normalStock: 4 },
            { category: 'åŒ…æé¡', name: 'å°å£è†œ', unit: '1ç®±50å·', stock: 5, shortage: 2, normalStock: 10 },
            { category: 'åŒ…æé¡', name: 'å¸ç®¡-ç²—', unit: '1ç®±5000æ”¯', stock: 2, shortage: 0, normalStock: 4 },
            { category: 'åŒ…æé¡', name: 'å¸ç®¡-ç´°', unit: '1ç®±5000æ”¯', stock: 3, shortage: 0, normalStock: 5 },
            { category: 'åŒ…æé¡', name: 'æ¯è“‹', unit: '1ç®±1000å€‹', stock: 4, shortage: 0, normalStock: 6 },
            { category: 'åŒ…æé¡', name: 'æè¢‹-å°', unit: '1ç®±1000å€‹', stock: 5, shortage: 1, normalStock: 8 },
            { category: 'åŒ…æé¡', name: 'æè¢‹-å¤§', unit: '1ç®±500å€‹', stock: 3, shortage: 0, normalStock: 5 },
            { category: 'åŒ…æé¡', name: 'æ¹¯åŒ™', unit: '1ç®±2000æ”¯', stock: 2, shortage: 0, normalStock: 4 },
            { category: 'åŒ…æé¡', name: 'å‰å­', unit: '1ç®±2000æ”¯', stock: 1, shortage: 0, normalStock: 3 },
            { category: 'åŒ…æé¡', name: 'é¤å·¾ç´™', unit: '1ç®±100åŒ…', stock: 8, shortage: 0, normalStock: 10 },
            { category: 'åŒ…æé¡', name: 'æ¸…æ½”ç”¨å“', unit: 'å¥—çµ„', stock: 1, shortage: 0, normalStock: 2 },
            { category: 'åŒ…æé¡', name: 'åƒåœ¾è¢‹', unit: '1ç®±100å…¥', stock: 2, shortage: 0, normalStock: 4 },
            { category: 'åŒ…æé¡', name: 'è¡›ç”Ÿç´™', unit: '1ç®±60åŒ…', stock: 4, shortage: 0, normalStock: 6 },
            { category: 'åŒ…æé¡', name: 'æ´—ç¢—ç²¾', unit: 'ç“¶', stock: 2, shortage: 0, normalStock: 3 },
            { category: 'åŒ…æé¡', name: 'å…­æ¯æ¶', unit: '1ç®±600å€‹', stock: 0, shortage: 0, normalStock: 2 },
            { category: 'åŒ…æé¡', name: 'é«˜æ¶µé¤Šé‡é…µç´ ', unit: 'å–®åŒ…è³¼', stock: 1, shortage: 0, normalStock: 2 },
            { category: 'åŒ…æé¡', name: 'APå…±ç”¨è†œ', unit: '1ç®±6å·', stock: 0, shortage: 0, normalStock: 2 },
            { category: 'åŒ…æé¡', name: 'å¤§ç’°ä¿ç“¶å«è“‹', unit: '1ç®±100å…¥', stock: 2, shortage: 0, normalStock: 4 },
            { category: 'åŒ…æé¡', name: 'PPè¢‹ 4*6å‚³å–®', unit: 'å–®åŒ…è³¼', stock: 0, shortage: 0, normalStock: 2 },
            { category: 'åŒ…æé¡', name: 'åŠŸå¤«èŒ¶æ¨™ç±¤ç´™', unit: '1æ¢5å·', stock: 0, shortage: 0, normalStock: 2 }
        ];

        let inventory = [];
        let currentView = 'quick';
        let usageLog = [];
        let quickFilterCategory = 'all';
        
        // Apps Script è¨­å®š
        let APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwMoHlG6eVKFERMNd5Bv7J2w6kcyeiZFw8dW9fT_8alkygScZIC-e6-qwiiRX013YL2CA/exec';
        
        // å¾localStorageè®€å–è¨­å®š
        function loadSheetsConfig() {
            const saved = localStorage.getItem('appsScriptUrl');
            if (saved) {
                APPS_SCRIPT_URL = saved;
            } else {
                // ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚ä¿å­˜é è¨­ URL
                localStorage.setItem('appsScriptUrl', APPS_SCRIPT_URL);
            }
        }
        
        // ä¿å­˜è¨­å®š
        function saveSheetsConfig() {
            localStorage.setItem('appsScriptUrl', APPS_SCRIPT_URL);
        }

        // ç›£è½ä¾†è‡ª iframe çš„åŒæ­¥çµæœ
        window.addEventListener('message', function(event) {
            // è™•ç†åŒæ­¥çµæœ
            if (event.data && event.data.success !== undefined) {
                const syncBtn = document.getElementById('syncBtn');
                if (syncBtn) {
                    syncBtn.disabled = false;
                    syncBtn.textContent = 'â­ ğŸ’¾ å„²å­˜åˆ°é›²ç«¯Excel â­';
                }
                
                if (event.data.success) {
                    showStatus(`âœ… å„²å­˜æˆåŠŸï¼å·²ä¸Šå‚³ ${event.data.count || inventory.length} é …å•†å“åˆ°é›²ç«¯`, 'success');
                } else {
                    showStatus(`âŒ å„²å­˜å¤±æ•—: ${event.data.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            }
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();
            const savedView = localStorage.getItem('viewMode') || 'quick';
            currentView = savedView;
            
            if (inventory.length === 0) {
                loadSampleData();
            } else {
                renderData();
                updateStats();
            }
            
            updateViewButtons();
        });

        // å¾æœ¬åœ°å„²å­˜è¼‰å…¥
        function loadFromStorage() {
            const saved = localStorage.getItem('inventory');
            if (saved) {
                inventory = JSON.parse(saved);
            }
            
            const savedLog = localStorage.getItem('usageLog');
            if (savedLog) {
                usageLog = JSON.parse(savedLog);
                // åªä¿ç•™ä»Šå¤©çš„è¨˜éŒ„
                const today = new Date().toDateString();
                usageLog = usageLog.filter(log => new Date(log.time).toDateString() === today);
            }
        }

        // å„²å­˜åˆ°æœ¬åœ°
        function saveToStorage() {
            localStorage.setItem('inventory', JSON.stringify(inventory));
            showStatus('âœ… å·²è‡ªå‹•å„²å­˜', 'success');
        }

        // è¼‰å…¥ç¯„ä¾‹è³‡æ–™
        function loadSampleData() {
            inventory = JSON.parse(JSON.stringify(defaultData));
            saveToStorage();
            renderData();
            updateStats();
            showStatus('âœ… ç¯„ä¾‹è³‡æ–™å·²è¼‰å…¥', 'success');
        }

        // åˆ‡æ›è¦–åœ–
        function switchView(view) {
            currentView = view;
            localStorage.setItem('viewMode', view);
            updateViewButtons();
            renderData();
        }

        // æ›´æ–°è¦–åœ–æŒ‰éˆ•ç‹€æ…‹
        function updateViewButtons() {
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const container = document.querySelector('.container');
            container.classList.remove('view-card', 'view-quick', 'view-order');
            
            const buttons = document.querySelectorAll('.view-btn');
            if (currentView === 'table') {
                buttons[0].classList.add('active');
            } else if (currentView === 'card') {
                buttons[1].classList.add('active');
                container.classList.add('view-card');
            } else if (currentView === 'quick') {
                buttons[2].classList.add('active');
                container.classList.add('view-quick');
            } else if (currentView === 'order') {
                buttons[3].classList.add('active');
                container.classList.add('view-order');
            }
        }

        // çµ±ä¸€æ¸²æŸ“å…¥å£
        function renderData(filteredData = null) {
            if (currentView === 'table') {
                renderTable(filteredData);
            } else if (currentView === 'card') {
                renderCards(filteredData);
            } else if (currentView === 'quick') {
                renderQuickView(filteredData);
            } else if (currentView === 'order') {
                renderOrderList();
            }
        }

        // é¡¯ç¤ºè¡¨æ ¼
        function renderTable(filteredData = null) {
            const data = filteredData || inventory;
            const tbody = document.getElementById('tableBody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">æš«ç„¡è³‡æ–™ï¼Œè«‹é»æ“Šã€Œè¼‰å…¥ç¯„ä¾‹è³‡æ–™ã€</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((item, index) => {
                const originalIndex = inventory.indexOf(item);
                const isLow = item.stock <= 3;
                const hasShortage = item.shortage > 0;
                const stockClass = isLow ? 'stock-low' : '';
                
                let statusText = '';
                if (item.stock === 0) {
                    statusText = 'ğŸ”´ ç¼ºè²¨';
                } else if (isLow) {
                    statusText = 'âš ï¸ ä½åº«å­˜';
                } else if (hasShortage) {
                    statusText = 'ğŸ“‹ éœ€è£œè²¨';
                } else {
                    statusText = 'âœ… æ­£å¸¸';
                }
                
                const stepValue = item.allowDecimal ? '0.1' : '1';
                const changeValue = item.allowDecimal ? 0.1 : 1;
                
                return `
                    <tr>
                        <td><strong>${item.category}</strong></td>
                        <td>${item.name}${item.note ? '<br><small style="color: #ff6b6b;">' + item.note + '</small>' : ''}</td>
                        <td>${item.unit}</td>
                        <td>
                            <input type="number" 
                                   class="stock-input" 
                                   value="${item.normalStock || 0}" 
                                   onchange="updateStock(${originalIndex}, this.value, 'normalStock')"
                                   min="0"
                                   step="${stepValue}">
                        </td>
                        <td>
                            <input type="number" 
                                   class="stock-input ${stockClass}" 
                                   value="${item.stock}" 
                                   onchange="updateStock(${originalIndex}, this.value, 'stock')"
                                   min="0"
                                   step="${stepValue}">
                        </td>
                        <td>
                            <input type="number" 
                                   class="stock-input ${hasShortage ? 'stock-low' : ''}" 
                                   value="${item.shortage || 0}" 
                                   onchange="updateStock(${originalIndex}, this.value, 'shortage')"
                                   min="0"
                                   step="1">
                        </td>
                        <td>
                            <button class="qty-btn btn-minus" onclick="changeStock(${originalIndex}, -${changeValue})">-</button>
                            <button class="qty-btn btn-plus" onclick="changeStock(${originalIndex}, ${changeValue})">+</button>
                            <button class="qty-btn btn-restock" onclick="showRestockDialog(${originalIndex})">ğŸ“¦ è£œè²¨</button>
                        </td>
                        <td>${statusText}</td>
                    </tr>
                `;
            }).join('');
        }

        // é¡¯ç¤ºå¡ç‰‡è¦–åœ–
        function renderCards(filteredData = null) {
            const data = filteredData || inventory;
            const cardView = document.getElementById('cardView');
            
            if (data.length === 0) {
                cardView.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æš«ç„¡è³‡æ–™ï¼Œè«‹é»æ“Šã€Œè¼‰å…¥ç¯„ä¾‹è³‡æ–™ã€</div>';
                return;
            }

            // æŒ‰é¡åˆ¥åˆ†çµ„
            const categories = {};
            data.forEach(item => {
                if (!categories[item.category]) {
                    categories[item.category] = [];
                }
                categories[item.category].push(item);
            });

            // æ¸²æŸ“æ¯å€‹é¡åˆ¥
            let html = '';
            Object.keys(categories).forEach(category => {
                const items = categories[category];
                const categoryIcon = getCategoryIcon(category);
                
                html += `
                    <div class="category-section">
                        <div class="category-title">
                            ${categoryIcon} ${category}
                            <span class="category-count">${items.length} é …</span>
                        </div>
                        <div class="cards-grid">
                `;
                
                items.forEach(item => {
                    const originalIndex = inventory.indexOf(item);
                    const isLow = item.stock <= 3 && item.stock > 0;
                    const isOutOfStock = item.stock === 0;
                    const hasShortage = item.shortage > 0;
                    
                    let cardClass = 'item-card';
                    let statusBadge = 'âœ…';
                    
                    if (isOutOfStock) {
                        cardClass += ' out-of-stock';
                        statusBadge = 'ğŸ”´';
                    } else if (isLow) {
                        cardClass += ' low-stock';
                        statusBadge = 'âš ï¸';
                    } else if (hasShortage) {
                        statusBadge = 'ğŸ“‹';
                    }
                    
                    const stepValue = item.allowDecimal ? '0.1' : '1';
                    const changeValue = item.allowDecimal ? 0.1 : 1;
                    
                    html += `
                        <div class="${cardClass}">
                            <div class="card-header">
                                <div>
                                    <div class="item-name">${item.name}</div>
                                    <span class="item-unit">${item.unit}</span>
                                    ${item.note ? '<div style="font-size: 0.75em; color: #ff6b6b; margin-top: 3px;">' + item.note + '</div>' : ''}
                                </div>
                                <span class="status-badge">${statusBadge}</span>
                            </div>
                            <div class="card-body">
                                <div class="stock-row">
                                    <span class="stock-label">ğŸ“Š å¸¸æ…‹åº«å­˜</span>
                                    <input type="number" 
                                           class="stock-input-card" 
                                           value="${item.normalStock || 0}" 
                                           onchange="updateStock(${originalIndex}, this.value, 'normalStock')"
                                           min="0"
                                           step="${stepValue}">
                                </div>
                                <div class="stock-row">
                                    <span class="stock-label">ğŸ’¼ ç¾æœ‰åº«å­˜</span>
                                    <input type="number" 
                                           class="stock-input-card ${isLow || isOutOfStock ? 'stock-low' : ''}" 
                                           value="${item.stock}" 
                                           onchange="updateStock(${originalIndex}, this.value, 'stock')"
                                           min="0"
                                           step="${stepValue}">
                                </div>
                                <div class="shortage-row">
                                    <span class="stock-label">ğŸ“¦ çŸ­ç¼ºæ•¸é‡</span>
                                    <input type="number" 
                                           class="stock-input-card ${hasShortage ? 'stock-low' : ''}" 
                                           value="${item.shortage || 0}" 
                                           onchange="updateStock(${originalIndex}, this.value, 'shortage')"
                                           min="0"
                                           step="1">
                                </div>
                                <div class="card-actions">
                                    <button class="qty-btn btn-minus" onclick="changeStock(${originalIndex}, -${changeValue})">â– ${item.allowDecimal ? '0.1' : '1'}</button>
                                    <button class="qty-btn btn-plus" onclick="changeStock(${originalIndex}, ${changeValue})">â• ${item.allowDecimal ? '0.1' : '1'}</button>
                                </div>
                                <div class="card-actions" style="margin-top: 5px;">
                                    <button class="qty-btn btn-restock" onclick="showRestockDialog(${originalIndex})" style="width: 100%;">ğŸ“¦ è£œè²¨åˆ°è²¨</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            cardView.innerHTML = html;
        }

        // å–å¾—é¡åˆ¥åœ–ç¤º
        function getCategoryIcon(category) {
            const icons = {
                'æœéœ²é¡': 'ğŸŠ',
                'ç²‰é¡': 'ğŸ¥„',
                'ç³–é¡': 'ğŸ¯',
                'èŒ¶è‘‰é¡': 'ğŸµ',
                'å°æ–™é¡': 'ğŸ§‹',
                'åŒ…æé¡': 'ğŸ“¦'
            };
            return icons[category] || 'ğŸ“Œ';
        }

        // é¡¯ç¤ºå¿«é€Ÿä½¿ç”¨è¦–åœ–
        function renderQuickView(filteredData = null) {
            const quickView = document.getElementById('quickView');
            
            let data = filteredData || inventory;
            
            // æ ¹æ“šé¡åˆ¥éæ¿¾
            if (quickFilterCategory !== 'all') {
                data = data.filter(item => item.category === quickFilterCategory);
            }
            
            if (data.length === 0) {
                quickView.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æš«ç„¡è³‡æ–™</div>';
                return;
            }

            // å–å¾—æ‰€æœ‰é¡åˆ¥
            const categories = ['all', ...new Set(inventory.map(item => item.category))];
            
            let html = `
                <div class="quick-search">
                    <input type="text" 
                           id="quickSearchInput" 
                           placeholder="ğŸ” å¿«é€Ÿæœå°‹å•†å“..." 
                           oninput="quickSearch(this.value)">
                </div>

                <div class="quick-category-filter">
                    ${categories.map(cat => `
                        <button class="filter-btn ${quickFilterCategory === cat ? 'active' : ''}" 
                                onclick="filterQuickCategory('${cat}')">
                            ${cat === 'all' ? 'ğŸŒŸ å…¨éƒ¨' : getCategoryIcon(cat) + ' ' + cat}
                        </button>
                    `).join('')}
                </div>
            `;

            // ä½¿ç”¨è¨˜éŒ„
            if (usageLog.length > 0) {
                html += `
                    <div class="usage-log">
                        <h4>ğŸ“ ä»Šæ—¥ä½¿ç”¨è¨˜éŒ„ï¼ˆ${usageLog.length} ç­†ï¼‰<span style="color: #999; font-size: 0.8em; margin-left: 10px;">é»æ“Šåˆªé™¤å¯å›è£œåº«å­˜</span></h4>
                        ${usageLog.slice().reverse().map((log, index) => {
                            const originalIndex = usageLog.length - 1 - index;
                            return `
                                <div class="usage-item ${log.recent ? 'recent' : ''}">
                                    <div>
                                        <strong>${log.itemName}</strong>
                                        <span style="color: #666; margin-left: 10px;">-${log.amount || 1}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span class="usage-time">${new Date(log.time).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}</span>
                                        <button class="usage-delete-btn" onclick="deleteUsageLog(${originalIndex})">âœ• åˆªé™¤</button>
                                    </div>
                                </div>
                            `;
                        }).slice(0, 10).join('')}
                    </div>
                `;
            }

            // å•†å“å¡ç‰‡
            html += '<div class="cards-grid">';
            
            data.forEach((item, index) => {
                const originalIndex = inventory.indexOf(item);
                const isLow = item.stock <= 3 && item.stock > 0;
                const isOutOfStock = item.stock === 0;
                
                let cardClass = 'quick-item';
                let stockClass = 'ok';
                let badge = '';
                
                if (isOutOfStock) {
                    cardClass += ' out-of-stock';
                    stockClass = 'out';
                    badge = 'ğŸ”´';
                } else if (isLow) {
                    cardClass += ' low-stock';
                    stockClass = 'low';
                    badge = 'âš ï¸';
                }
                
                const useAmount = item.allowDecimal ? 0.1 : 1;
                const disabled = isOutOfStock ? '' : `onclick="quickUseItem(${originalIndex}, ${useAmount})"`;
                
                html += `
                    <div class="${cardClass}" ${disabled}>
                        <div class="quick-item-badge">${badge}</div>
                        <div class="quick-item-name">${item.name}</div>
                        ${item.note ? '<div style="font-size: 0.75em; color: #ff6b6b; margin: 3px 0;">' + item.note + '</div>' : ''}
                        <div class="quick-item-stock ${stockClass}">${item.stock}</div>
                        <div class="quick-item-unit">${item.unit}</div>
                        <div style="margin-top: 10px; color: #999; font-size: 0.9em;">
                            ${isOutOfStock ? 'å·²ç¼ºè²¨' : `é»æ“Šä½¿ç”¨ -${useAmount}`}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            quickView.innerHTML = html;
        }

        // å¿«é€Ÿä½¿ç”¨å•†å“
        function quickUseItem(index, amount = 1) {
            if (inventory[index].stock < amount) {
                showStatus('âŒ åº«å­˜ä¸è¶³ï¼Œç„¡æ³•ä½¿ç”¨', 'error');
                return;
            }
            
            inventory[index].stock = Math.round((inventory[index].stock - amount) * 10) / 10;
            
            // è¨˜éŒ„ä½¿ç”¨
            const log = {
                itemName: inventory[index].name,
                category: inventory[index].category,
                amount: amount,
                remainingStock: inventory[index].stock,
                time: new Date().toISOString(),
                recent: true,
                deleted: false
            };
            usageLog.push(log);
            
            // ä¿å­˜åˆ°æœ¬åœ°
            localStorage.setItem('usageLog', JSON.stringify(usageLog));
            saveToStorage();
            
            // åŒæ­¥è¨˜éŒ„åˆ° Google Sheets
            syncUsageLogToSheets(log);
            
            // æ›´æ–°é¡¯ç¤º
            renderQuickView();
            updateStats();
            
            // ç§»é™¤recentæ¨™è¨˜
            setTimeout(() => {
                if (usageLog.length > 0) {
                    usageLog[usageLog.length - 1].recent = false;
                }
            }, 500);
            
            showStatus(`âœ… ${inventory[index].name} å·²ä½¿ç”¨ ${amount}ï¼Œå‰©é¤˜ ${inventory[index].stock}`, 'success');
        }

        // å¿«é€Ÿæœå°‹
        function quickSearch(search) {
            if (!search) {
                renderQuickView();
                return;
            }
            
            const filtered = inventory.filter(item => 
                item.name.toLowerCase().includes(search.toLowerCase()) ||
                item.category.toLowerCase().includes(search.toLowerCase())
            );
            renderQuickView(filtered);
        }

        // éæ¿¾é¡åˆ¥
        function filterQuickCategory(category) {
            quickFilterCategory = category;
            renderQuickView();
        }

        // åˆªé™¤ä½¿ç”¨è¨˜éŒ„ä¸¦å›è£œåº«å­˜
        function deleteUsageLog(logIndex) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨˜éŒ„ä¸¦å›è£œåº«å­˜å—ï¼Ÿ')) {
                return;
            }
            
            const log = usageLog[logIndex];
            
            // æ‰¾åˆ°å°æ‡‰çš„å•†å“ä¸¦å›è£œåº«å­˜
            const itemIndex = inventory.findIndex(item => item.name === log.itemName);
            
            if (itemIndex !== -1) {
                const amount = log.amount || 1;
                inventory[itemIndex].stock = Math.round((inventory[itemIndex].stock + amount) * 10) / 10;
                
                // è¨˜éŒ„åˆªé™¤å›è£œæ“ä½œåˆ° Sheets
                const deleteLog = {
                    itemName: log.itemName,
                    category: log.category,
                    amount: amount,
                    remainingStock: inventory[itemIndex].stock,
                    time: new Date().toISOString(),
                    deleted: true
                };
                syncUsageLogToSheets(deleteLog);
                
                // åˆªé™¤æœ¬åœ°è¨˜éŒ„
                usageLog.splice(logIndex, 1);
                
                // ä¿å­˜
                localStorage.setItem('usageLog', JSON.stringify(usageLog));
                saveToStorage();
                
                // æ›´æ–°é¡¯ç¤º
                renderQuickView();
                updateStats();
                
                showStatus(`âœ… å·²åˆªé™¤è¨˜éŒ„ä¸¦å›è£œ ${log.itemName} ${amount}ï¼Œç•¶å‰åº«å­˜ ${inventory[itemIndex].stock}`, 'success');
            } else {
                showStatus('âŒ æ‰¾ä¸åˆ°å°æ‡‰å•†å“', 'error');
            }
        }

        // é¡¯ç¤ºå«è²¨æ¸…å–®
        function renderOrderList() {
            const orderView = document.getElementById('orderView');
            
            // è®¡ç®—éœ€è¦å«è´§çš„å•†å“
            const needOrder = inventory.filter(item => {
                const normalStock = item.normalStock || 0;
                const currentStock = item.stock || 0;
                return currentStock < normalStock;
            }).map(item => {
                const normalStock = item.normalStock || 0;
                const currentStock = item.stock || 0;
                const needQuantity = normalStock - currentStock;
                return { ...item, needQuantity };
            });

            if (needOrder.length === 0) {
                orderView.innerHTML = `
                    <div style="text-align: center; padding: 60px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">âœ…</div>
                        <h2 style="color: #38ef7d;">åº«å­˜å……è¶³ï¼</h2>
                        <p style="color: #666; margin-top: 10px;">ç›®å‰æ²’æœ‰éœ€è¦è£œè²¨çš„å•†å“</p>
                    </div>
                `;
                return;
            }

            // ç»Ÿè®¡æ•°æ®
            const totalItems = needOrder.length;
            const totalQuantity = needOrder.reduce((sum, item) => sum + item.needQuantity, 0);
            const urgentItems = needOrder.filter(item => item.stock === 0).length;

            let html = `
                <div class="order-summary">
                    <h3>ğŸ“‹ å«è²¨æ¸…å–®ç¸½è¦½</h3>
                    <div class="order-stats">
                        <div class="order-stat-item">
                            <div class="order-stat-label">éœ€è£œè²¨å“é …</div>
                            <div class="order-stat-value">${totalItems}</div>
                        </div>
                        <div class="order-stat-item">
                            <div class="order-stat-label">ç¸½éœ€æ±‚æ•¸é‡</div>
                            <div class="order-stat-value">${totalQuantity}</div>
                        </div>
                        <div class="order-stat-item">
                            <div class="order-stat-label">æ€¥éœ€è£œè²¨ï¼ˆç¼ºè²¨ï¼‰</div>
                            <div class="order-stat-value">${urgentItems}</div>
                        </div>
                    </div>
                </div>

                <table class="order-table">
                    <thead>
                        <tr>
                            <th>å„ªå…ˆç´š</th>
                            <th>é¡åˆ¥</th>
                            <th>å•†å“åç¨±</th>
                            <th>å–®ä½</th>
                            <th>å¸¸æ…‹åº«å­˜</th>
                            <th>ç¾æœ‰åº«å­˜</th>
                            <th>éœ€è£œè²¨æ•¸é‡</th>
                            <th>å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // æŒ‰ä¼˜å…ˆçº§æ’åºï¼šç¼ºè´§ > ä½åº“å­˜ > å…¶ä»–
            needOrder.sort((a, b) => {
                if (a.stock === 0 && b.stock !== 0) return -1;
                if (a.stock !== 0 && b.stock === 0) return 1;
                if (a.stock <= 3 && b.stock > 3) return -1;
                if (a.stock > 3 && b.stock <= 3) return 1;
                return b.needQuantity - a.needQuantity;
            });

            needOrder.forEach((item, index) => {
                let priority = '';
                let priorityClass = '';
                
                if (item.stock === 0) {
                    priority = 'ğŸ”´ ç·Šæ€¥';
                    priorityClass = 'urgent';
                } else if (item.stock <= 3) {
                    priority = 'âš ï¸ å„ªå…ˆ';
                    priorityClass = 'high';
                } else {
                    priority = 'ğŸ“‹ ä¸€èˆ¬';
                    priorityClass = 'normal';
                }

                html += `
                    <tr>
                        <td><span class="need-order-badge">${priority}</span></td>
                        <td><strong>${item.category}</strong></td>
                        <td>${item.name}</td>
                        <td>${item.unit}</td>
                        <td>${item.normalStock}</td>
                        <td style="color: ${item.stock === 0 ? '#dc3545' : (item.stock <= 3 ? '#ff6b6b' : '#333')}">
                            <strong>${item.stock}</strong>
                        </td>
                        <td style="color: #ff6b6b; font-weight: bold; font-size: 1.1em;">
                            ${item.needQuantity}
                        </td>
                        <td>${item.stock === 0 ? 'âš ï¸ å·²ç¼ºè²¨' : (item.stock <= 3 ? 'å³å°‡ç”¨å®Œ' : 'æ­£å¸¸è£œè²¨')}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            orderView.innerHTML = html;
        }

        // åŒ¯å‡ºå«è²¨æ¸…å–®
        function exportOrderList() {
            const needOrder = inventory.filter(item => {
                const normalStock = item.normalStock || 0;
                const currentStock = item.stock || 0;
                return currentStock < normalStock;
            }).map(item => {
                const normalStock = item.normalStock || 0;
                const currentStock = item.stock || 0;
                const needQuantity = normalStock - currentStock;
                return { ...item, needQuantity };
            });

            if (needOrder.length === 0) {
                showStatus('âœ… ç›®å‰æ²’æœ‰éœ€è¦è£œè²¨çš„å•†å“', 'success');
                return;
            }

            // æ’åº
            needOrder.sort((a, b) => {
                if (a.stock === 0 && b.stock !== 0) return -1;
                if (a.stock !== 0 && b.stock === 0) return 1;
                if (a.stock <= 3 && b.stock > 3) return -1;
                if (a.stock > 3 && b.stock <= 3) return 1;
                return b.needQuantity - a.needQuantity;
            });

            let csv = 'å„ªå…ˆç´š,é¡åˆ¥,å•†å“åç¨±,å–®ä½,å¸¸æ…‹åº«å­˜,ç¾æœ‰åº«å­˜,éœ€è£œè²¨æ•¸é‡,å‚™è¨»\n';
            needOrder.forEach(item => {
                let priority = '';
                let note = '';
                
                if (item.stock === 0) {
                    priority = 'ç·Šæ€¥';
                    note = 'å·²ç¼ºè²¨';
                } else if (item.stock <= 3) {
                    priority = 'å„ªå…ˆ';
                    note = 'å³å°‡ç”¨å®Œ';
                } else {
                    priority = 'ä¸€èˆ¬';
                    note = 'æ­£å¸¸è£œè²¨';
                }

                csv += `${priority},${item.category},${item.name},${item.unit},${item.normalStock},${item.stock},${item.needQuantity},${note}\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const today = new Date().toLocaleDateString('zh-TW').replace(/\//g, '-');
            link.setAttribute('href', url);
            link.setAttribute('download', `å«è²¨æ¸…å–®_æ¥Šæ¢…å››ç¶­åº—_${today}.csv`);
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showStatus(`âœ… å«è²¨æ¸…å–®å·²ä¸‹è¼‰ï¼å…± ${needOrder.length} é …å•†å“éœ€è¦è£œè²¨`, 'success');
        }

        // æ›´æ–°åº«å­˜
        function updateStock(index, value, field = 'stock') {
            // å°æ–¼å…è¨±å°æ•¸çš„å•†å“ï¼Œä½¿ç”¨parseFloatï¼Œå¦å‰‡ä½¿ç”¨parseInt
            const newValue = inventory[index].allowDecimal ? parseFloat(value) : parseInt(value);
            
            if (isNaN(newValue) || newValue < 0) {
                showStatus('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—', 'error');
                renderData();
                return;
            }
            
            // å°å°æ•¸é€²è¡Œå››æ¨äº”å…¥åˆ°ä¸€ä½å°æ•¸
            const finalValue = inventory[index].allowDecimal ? 
                Math.round(newValue * 10) / 10 : 
                newValue;
            
            if (field === 'stock') {
                inventory[index].stock = finalValue;
            } else if (field === 'shortage') {
                inventory[index].shortage = parseInt(value); // çŸ­ç¼ºæ•¸é‡å§‹çµ‚æ˜¯æ•´æ•¸
            } else if (field === 'normalStock') {
                inventory[index].normalStock = finalValue;
            }
            
            saveToStorage();
            renderData();
            updateStats();
        }

        // å¢æ¸›åº«å­˜
        function changeStock(index, change) {
            let newStock = inventory[index].stock + change;
            
            // å°å°æ•¸é€²è¡Œå››æ¨äº”å…¥åˆ°ä¸€ä½å°æ•¸
            if (inventory[index].allowDecimal) {
                newStock = Math.round(newStock * 10) / 10;
            }
            
            if (newStock < 0) {
                showStatus('âŒ åº«å­˜ä¸èƒ½ç‚ºè² æ•¸', 'error');
                return;
            }
            
            inventory[index].stock = newStock;
            saveToStorage();
            renderData();
            updateStats();
        }

        // æ›´æ–°çµ±è¨ˆ
        function updateStats() {
            document.getElementById('totalItems').textContent = inventory.length;
            document.getElementById('lowStock').textContent = 
                inventory.filter(item => item.stock <= 3 && item.stock > 0).length;
            document.getElementById('needRestock').textContent = 
                inventory.filter(item => item.shortage > 0).length;
            document.getElementById('outOfStock').textContent = 
                inventory.filter(item => item.stock === 0).length;
        }

        // æœå°‹éæ¿¾
        function filterData() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            if (!search) {
                renderData();
                return;
            }

            const filtered = inventory.filter(item => 
                item.name.toLowerCase().includes(search) ||
                item.category.toLowerCase().includes(search)
            );
            renderData(filtered);
        }

        // åŒ¯å‡º CSV
        function exportToCSV() {
            if (inventory.length === 0) {
                showStatus('âŒ æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º', 'error');
                return;
            }

            let csv = 'é¡åˆ¥,å•†å“åç¨±,å–®ä½,å¸¸æ…‹åº«å­˜,ç¾æœ‰åº«å­˜,çŸ­ç¼ºæ•¸é‡\n';
            inventory.forEach(item => {
                csv += `${item.category},${item.name},${item.unit},${item.normalStock || 0},${item.stock},${item.shortage || 0}\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const today = new Date().toLocaleDateString('zh-TW').replace(/\//g, '-');
            link.setAttribute('href', url);
            link.setAttribute('download', `åŠŸå¤«èŒ¶åº«å­˜_æ¥Šæ¢…å››ç¶­åº—_${today}.csv`);
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showStatus('âœ… CSV æª”æ¡ˆå·²ä¸‹è¼‰ï¼å¯åœ¨ Excel æˆ– Google Sheets ä¸­é–‹å•Ÿ', 'success');
        }

        // æ¸…ç©ºè³‡æ–™
        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                inventory = [];
                localStorage.removeItem('inventory');
                renderData();
                updateStats();
                showStatus('âœ… æ‰€æœ‰è³‡æ–™å·²æ¸…ç©º', 'success');
            }
        }

        // é¡¯ç¤ºç‹€æ…‹
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            setTimeout(() => {
                status.className = 'status';
            }, 3000);
        }

        // åˆ‡æ›ä½¿ç”¨èªªæ˜æ¡†
        function toggleInfoBox() {
            const infoBox = document.getElementById('infoBox');
            const infoBoxContent = infoBox.querySelector('.info-box-content');
            
            // ç¬¬ä¸€æ¬¡é»æ“Šæ™‚ç§»é™¤å…§è¯æ¨£å¼ï¼Œè®“ CSS é¡ä¾†æ§åˆ¶
            if (infoBoxContent && infoBoxContent.hasAttribute('style')) {
                infoBoxContent.removeAttribute('style');
            }
            
            infoBox.classList.toggle('collapsed');
            
            // ä¸è¨˜ä½ç”¨æˆ¶åå¥½ï¼Œç¢ºä¿åˆ·æ–°å¾Œç¸½æ˜¯æ”¶åˆ
            // localStorage.setItem('infoBoxCollapsed', 'true');
        }

        // è¼‰å…¥ä½¿ç”¨èªªæ˜æ¡†ç‹€æ…‹
        function loadInfoBoxState() {
            const isCollapsed = localStorage.getItem('infoBoxCollapsed');
            if (isCollapsed === 'false') {
                document.getElementById('infoBox').classList.remove('collapsed');
            }
        }

        // åœ¨åˆå§‹åŒ–æ™‚è¼‰å…¥ä½¿ç”¨èªªæ˜æ¡†ç‹€æ…‹ï¼ˆå·²åœç”¨ï¼Œé è¨­æ”¶åˆï¼‰
        window.addEventListener('DOMContentLoaded', () => {
            // loadInfoBoxState();  // è¨»è§£æ‰ï¼šç¢ºä¿å¿«é€Ÿä¸Šæ‰‹æŒ‡å—é è¨­æ”¶åˆ
            // å¼·åˆ¶è¨­ç½®ç‚ºæ”¶åˆç‹€æ…‹
            const infoBox = document.getElementById('infoBox');
            if (infoBox && !infoBox.classList.contains('collapsed')) {
                infoBox.classList.add('collapsed');
            }
            localStorage.setItem('infoBoxCollapsed', 'true');  // æ›´æ–°æœ¬åœ°å„²å­˜
            loadSheetsConfig();
        });

        // é¡¯ç¤º Apps Script è¨­å®šå°è©±æ¡†
        function showSheetsConfig() {
            const currentUrl = APPS_SCRIPT_URL || 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
            
            const message = `è«‹è¼¸å…¥ Apps Script URL:\n\n` +
                          `ç¯„ä¾‹æ ¼å¼ï¼š\n` +
                          `https://script.google.com/macros/s/.../exec\n\n` +
                          `å¦‚ä½•å–å¾— URLï¼š\n` +
                          `1. é–‹å•Ÿ Google Sheets\n` +
                          `2. æ“´å……åŠŸèƒ½ â†’ Apps Script\n` +
                          `3. è²¼ä¸Šç¨‹å¼ç¢¼ä¸¦éƒ¨ç½²\n` +
                          `4. è¤‡è£½ç¶²è·¯æ‡‰ç”¨ç¨‹å¼ URL`;
            
            const url = prompt(message, currentUrl);
            
            if (url === null) return;
            
            if (!url || !url.includes('script.google.com')) {
                showStatus('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„ Apps Script URL', 'error');
                return;
            }
            
            APPS_SCRIPT_URL = url.trim();
            saveSheetsConfig();
            showStatus('âœ… Apps Script URL å·²å„²å­˜', 'success');
        }

        // åŒæ­¥åˆ° Google Sheetsï¼ˆä½¿ç”¨éš±è—è¡¨å–®é¿å… CORSï¼‰
        function syncToSheets() {
            if (!APPS_SCRIPT_URL) {
                showStatus('âŒ è«‹å…ˆè¨­å®š Apps Script URL', 'error');
                showSheetsConfig();
                return;
            }
            
            const syncBtn = document.getElementById('syncBtn');
            syncBtn.disabled = true;
            syncBtn.textContent = 'â³ å„²å­˜ä¸­...è«‹ç¨å€™';
            
            // å»ºç«‹éš±è—çš„ iframe ä¾†æ¥æ”¶å›æ‡‰
            let iframe = document.getElementById('syncFrame');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'syncFrame';
                iframe.name = 'syncFrame';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
            }
            
            // å»ºç«‹è¡¨å–®
            let form = document.getElementById('syncForm');
            if (!form) {
                form = document.createElement('form');
                form.id = 'syncForm';
                form.method = 'POST';
                form.target = 'syncFrame';
                form.style.display = 'none';
                document.body.appendChild(form);
            }
            
            // è¨­å®šè¡¨å–®
            form.action = APPS_SCRIPT_URL;
            form.innerHTML = '';
            
            // å»ºç«‹è³‡æ–™è¼¸å…¥
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'data';
            input.value = JSON.stringify({
                action: 'syncInventory',
                inventory: inventory
            });
            form.appendChild(input);
            
            // æäº¤è¡¨å–®
            form.submit();
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯ï¼ˆå› ç‚ºç„¡æ³•å¾—çŸ¥å¯¦éš›çµæœï¼‰
            setTimeout(() => {
                syncBtn.disabled = false;
                syncBtn.textContent = 'â­ ğŸ’¾ å„²å­˜åˆ°é›²ç«¯Excel â­';
                showStatus(`âœ… å·²å„²å­˜åˆ°é›²ç«¯Excelï¼è³‡æ–™å·²è‡ªå‹•å‚™ä»½`, 'success');
            }, 2000);
        }

        // æ‰“é–‹å¯†ç¢¼å½ˆçª—
        function showPasswordModal() {
            const modal = document.getElementById('passwordModal');
            const input = document.getElementById('passwordInput');
            modal.classList.add('active');
            input.value = '';
            
            // è‡ªå‹•èšç„¦åˆ°è¼¸å…¥æ¡†
            setTimeout(() => {
                input.focus();
            }, 300);
        }

        // é—œé–‰å¯†ç¢¼å½ˆçª—
        function closePasswordModal() {
            const modal = document.getElementById('passwordModal');
            const input = document.getElementById('passwordInput');
            const dialog = document.querySelector('.modal-dialog');
            
            modal.classList.remove('active');
            input.value = '';
            input.classList.remove('error', 'success');
            dialog.classList.remove('success');
        }

        // é»æ“ŠèƒŒæ™¯é—œé–‰å½ˆçª—
        function handleModalOverlayClick(event) {
            if (event.target.id === 'passwordModal') {
                closePasswordModal();
            }
        }

        // è™•ç†Enteréµ
        function handlePasswordKeypress(event) {
            if (event.key === 'Enter') {
                verifyPassword();
            }
        }

        // é©—è­‰å¯†ç¢¼ä¸¦è®€å–è³‡æ–™
        function verifyPassword() {
            const input = document.getElementById('passwordInput');
            const dialog = document.querySelector('.modal-dialog');
            const password = input.value;
            
            if (!password) {
                showStatus('âŒ è«‹è¼¸å…¥å¯†ç¢¼', 'error');
                input.classList.add('error');
                setTimeout(() => input.classList.remove('error'), 500);
                return;
            }
            
            if (password !== '0825') {
                showStatus('âŒ å¯†ç¢¼éŒ¯èª¤ï¼åªæœ‰åº—é•·/å‰¯åº—é•·å¯ä»¥è®€å–é›²ç«¯è³‡æ–™', 'error');
                input.classList.add('error');
                input.value = '';
                setTimeout(() => {
                    input.classList.remove('error');
                    input.focus();
                }, 500);
                return;
            }
            
            // å¯†ç¢¼æ­£ç¢º - é¡¯ç¤ºæˆåŠŸåé¥‹
            input.classList.add('success');
            dialog.classList.add('success');
            showStatus('âœ… å¯†ç¢¼æ­£ç¢ºï¼æ­£åœ¨è®€å–è³‡æ–™...', 'success');
            
            // å»¶é²é—œé–‰å½ˆçª—ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°æˆåŠŸåé¥‹
            setTimeout(() => {
                closePasswordModal();
                performLoadFromSheets();
            }, 600);
        }

        // å¾ Google Sheets è®€å–ï¼ˆä½¿ç”¨ JSONP é¿å… CORSï¼‰
        function loadFromSheets() {
            if (!APPS_SCRIPT_URL) {
                showStatus('âŒ è«‹å…ˆè¨­å®š Apps Script URL', 'error');
                showSheetsConfig();
                return;
            }
            
            // é¡¯ç¤ºå¯†ç¢¼é©—è­‰å½ˆçª—
            showPasswordModal();
        }

        // åŸ·è¡Œå¯¦éš›çš„è®€å–æ“ä½œ
        function performLoadFromSheets() {
            showStatus('â³ æ­£åœ¨å¾é›²ç«¯Excelè®€å–è³‡æ–™...', 'info');
            
            // ä½¿ç”¨ JSONP æŠ€è¡“
            const callbackName = 'jsonpCallback_' + Date.now();
            
            window[callbackName] = function(result) {
                console.log('è®€å–çµæœ:', result);
                
                if (!result.success) {
                    showStatus(`âŒ è®€å–å¤±æ•—: ${result.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                    delete window[callbackName];
                    return;
                }
                
                if (!result.data || result.data.length === 0) {
                    showStatus('âš ï¸ é›²ç«¯Excelä¸­æ²’æœ‰è³‡æ–™ã€‚è«‹è¯çµ¡ç®¡ç†å“¡è¨­å®š', 'error');
                    delete window[callbackName];
                    return;
                }
                
                // ä½¿ç”¨å›å‚³çš„è³‡æ–™
                inventory = result.data;
                
                saveToStorage();
                renderData();
                updateStats();
                
                showStatus(`âœ… æˆåŠŸå¾é›²ç«¯Excelè¼‰å…¥ ${inventory.length} é …å•†å“ï¼`, 'success');
                
                // æ¸…ç†
                delete window[callbackName];
                const script = document.getElementById(callbackName);
                if (script) {
                    script.remove();
                }
            };
            
            // å»ºç«‹ script æ¨™ç±¤
            const script = document.createElement('script');
            script.id = callbackName;
            script.src = `${APPS_SCRIPT_URL}?action=getInventory&callback=${callbackName}`;
            script.onerror = function() {
                showStatus('âŒ è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ URL æ˜¯å¦æ­£ç¢º', 'error');
                delete window[callbackName];
            };
            
            document.body.appendChild(script);
        }

        // åŒæ­¥ä½¿ç”¨è¨˜éŒ„åˆ° Google Sheets
        function syncUsageLogToSheets(log) {
            if (!APPS_SCRIPT_URL) {
                return; // æ²’è¨­å®š URL å°±ä¸åŒæ­¥ï¼Œåªä¿å­˜åœ¨æœ¬åœ°
            }
            
            // å»ºç«‹éš±è—è¡¨å–®
            let form = document.getElementById('logForm');
            if (!form) {
                form = document.createElement('form');
                form.id = 'logForm';
                form.method = 'POST';
                form.target = 'logFrame';
                form.style.display = 'none';
                document.body.appendChild(form);
                
                // å»ºç«‹ iframe
                const iframe = document.createElement('iframe');
                iframe.name = 'logFrame';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
            }
            
            // è¨­å®šè¡¨å–®
            form.action = APPS_SCRIPT_URL;
            form.innerHTML = '';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'data';
            input.value = JSON.stringify({
                action: 'logUsage',
                log: log
            });
            form.appendChild(input);
            
            // æäº¤
            form.submit();
        }

        // é¡¯ç¤ºè£œè²¨å°è©±æ¡†
        function showRestockDialog(index) {
            const item = inventory[index];
            const needRestock = Math.max(0, (item.normalStock || 0) - item.stock);
            const suggestAmount = needRestock > 0 ? needRestock : 1;
            
            const quantity = prompt(
                `ğŸ“¦ ${item.name} - è£œè²¨åˆ°è²¨\n\n` +
                `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                `ğŸ“Š ç›®å‰åº«å­˜ï¼š${item.stock} ${item.unit}\n` +
                `ğŸ¯ å¸¸æ…‹åº«å­˜ï¼š${item.normalStock || 0} ${item.unit}\n` +
                `âš ï¸  éœ€è¦è£œè²¨ï¼š${needRestock} ${item.unit}\n` +
                `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
                `ğŸ’¡ è«‹è¼¸å…¥åˆ°è²¨æ•¸é‡ï¼š`,
                suggestAmount
            );
            
            if (quantity === null || quantity === '') {
                return;
            }
            
            const amount = parseFloat(quantity);
            
            if (isNaN(amount) || amount <= 0) {
                showStatus('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡', 'error');
                return;
            }
            
            // ç›´æ¥è¡¥è´§ï¼Œä¸å†è¯¢é—®å¤‡æ³¨
            restockItem(index, amount, '');
        }

        // åŸ·è¡Œè£œè²¨
        function restockItem(index, amount, note) {
            const item = inventory[index];
            const beforeStock = item.stock;
            
            // å¢åŠ åº«å­˜
            item.stock = Math.round((item.stock + amount) * 10) / 10;
            const afterStock = item.stock;
            
            // è¨˜éŒ„è£œè²¨
            const log = {
                itemName: item.name,
                category: item.category,
                amount: amount,
                beforeStock: beforeStock,
                afterStock: afterStock,
                note: note,
                time: new Date().toISOString()
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°
            saveToStorage();
            
            // åŒæ­¥è¨˜éŒ„åˆ° Google Sheets
            syncRestockLogToSheets(log);
            
            // æ›´æ–°é¡¯ç¤º
            renderData();
            updateStats();
            
            showStatus(`âœ… è£œè²¨æˆåŠŸï¼${item.name} +${amount} | åº«å­˜ï¼š${beforeStock} â†’ ${afterStock}`, 'success');
        }

        // åŒæ­¥è£œè²¨è¨˜éŒ„åˆ° Google Sheets
        function syncRestockLogToSheets(log) {
            if (!APPS_SCRIPT_URL) {
                return;
            }
            
            let form = document.getElementById('restockForm');
            if (!form) {
                form = document.createElement('form');
                form.id = 'restockForm';
                form.method = 'POST';
                form.target = 'restockFrame';
                form.style.display = 'none';
                document.body.appendChild(form);
                
                const iframe = document.createElement('iframe');
                iframe.name = 'restockFrame';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
            }
            
            form.action = APPS_SCRIPT_URL;
            form.innerHTML = '';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'data';
            input.value = JSON.stringify({
                action: 'logRestock',
                log: log
            });
            form.appendChild(input);
            
            form.submit();
        }

        // è‡ªå‹•åŒæ­¥ï¼ˆå¯é¸ï¼‰
        function enableAutoSync(intervalMinutes = 5) {
            if (!APPS_SCRIPT_URL) {
                console.warn('è«‹å…ˆè¨­å®š Apps Script URL');
                return;
            }
            
            console.log(`å·²å•Ÿç”¨è‡ªå‹•åŒæ­¥ï¼Œæ¯ ${intervalMinutes} åˆ†é˜åŒæ­¥ä¸€æ¬¡`);
            
            setInterval(() => {
                if (APPS_SCRIPT_URL) {
                    console.log('è‡ªå‹•åŒæ­¥ä¸­...');
                    syncToSheets();
                }
            }, intervalMinutes * 60 * 1000);
        }

        // ä¸‹æ‹‰èœå–®æ§åˆ¶
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const isActive = dropdown.classList.contains('active');
            
            // é—œé–‰æ‰€æœ‰ä¸‹æ‹‰èœå–®
            document.querySelectorAll('.dropdown').forEach(d => {
                d.classList.remove('active');
            });
            
            // åˆ‡æ›ç•¶å‰ä¸‹æ‹‰èœå–®
            if (!isActive) {
                dropdown.classList.add('active');
            }
        }

        function closeDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.classList.remove('active');
        }

        // é»æ“Šå¤–éƒ¨é—œé–‰ä¸‹æ‹‰èœå–®
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown').forEach(d => {
                    d.classList.remove('active');
                });
            }
        });
    </script>
</body>
</html>

